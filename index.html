<html>
<head>
  <meta charset="utf-8"/>
  <meta name="description" content="Apple IIe Computer written in ES6">
  <meta name="author" content="John Clark">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.png">
  <title>Apple IIe</title>
  <style type="text/css">
    body {
        margin: 0px;
        padding: 0px;
        border: 0px;
        font-size: 13px;
        font-family: "Lucida Console", Monaco, monospace;
        background: #e1e1d0;
      }
    canvas.screen {
        margin: 1.4em;
        min-width: 800;
        min-height: 600;
        border: 5px double #5b4125;
    }
    div.col1>div {
        margin-left: 2em;
    }
    button {
        margin: 4px;
        margin-top: 0;
        padding-bottom: 2px;
        border: 1px solid #c5c5c5;
        border-radius: 4px;
        width: 6em;
        height: 2.5em;
        font-size: 13px;
        color: #f5f5ef;
        background: #734d26;
    }
    button:hover:active {
        color: #520;
        background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #377b7b), color-stop(1, #499));
        background:-moz-linear-gradient(center top, #377b7b 5%, #499 100%);
    }
    button:hover {
        background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #86592d), color-stop(1, #734d26));
        background:-moz-linear-gradient(center top, #86592d 5%, #734d26 100%);
    }
    div.drive_leds {
        margin-left: 4em;
        padding: 6px;
        border: 1px solid #734d26;
        white-space: nowrap;
        display: inline-block;
        vertical-align: middle;
    }
    div.drive_leds>span {
        margin: 6px;
        padding: 7px;
        padding-top: 4px;
        padding-bottom: 4px;
        border-radius: 10px;
        font-size: 9px;
        color: #734d26;
        background: #ccc;
    }
    div.drive_leds>span.active {
        color: #e1e1d0;
        background: radial-gradient(#d00, #900);
    }
  </style>
</head>

<body>
  <div class="row">
    <div class="col1">
      <canvas class="screen" width="564" height="390"></canvas>
      <div><button id="run_stop">run</button><button id="reset">reset</button><div class="drive_leds"><span>1</span><span>2</span></div></div>
      <div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div>
      <div><span>see it on <a target="_blank" href="https://github.com/inindev/apple2e">github</a></span></div>
    </div>
    <div class="col2">
    </div>
    <div class="col3">
    </div>
  </div>

  <script src="w65c02s.js"></script>
  <script src="memory.js"></script>
  <script src="io_manager.js"></script>
  <script src="text_display.js"></script>
  <script src="hires_display.js"></script>
  <script src="keyboard.js"></script>
  <script src="rom/342-0265-a.js"></script>
  <script src="rom/342-0304-cd.js"></script>
  <script src="rom/342-0303-ef.js"></script>

  <script>
    const mem = new Memory(rom_342_0304_cd, rom_342_0303_ef);
    const cpu = new W65C02S(mem);
    const kbd = new Keyboard();

    let io_mgr;
    let display_text;
    let display_hires;

    let run_stop_btn;
    let cycles;
    let interval;
    let last_ms;


    function run_toggle() {
        if(interval) {
            stop();
        } else {
            run();
        }
    }

    function stop() {
        run_stop_btn.innerText = "run";
        if(interval) {
            window.cancelAnimationFrame(interval);
            interval = undefined;
        }
    }

    function run() {
        run_stop_btn.innerText = "stop";
        if(interval) return;

        last_ms = performance.now();
        interval = window.requestAnimationFrame(on_interval);
    }

    function on_interval(now_ms) {
        const interval_cycles = (((now_ms-last_ms) * 1023) & 0x7fff) + cycles;
        last_ms = now_ms;
        while(cycles < interval_cycles) {
           cycles += cpu.step();
        };
        interval = window.requestAnimationFrame(on_interval);
    }

    function reset(event) {
        const was_stopped = !interval;
        stop();

        cpu.reset();
        display_text.reset();
        display_hires.reset();
        cycles = 0;

        if(event && (event.shiftKey || event.altKey || event.metaKey)) {
            mem.reset(); // hard reset
        }

        cpu.register.pc = mem.read_word(0xfffc);
        if(!was_stopped) run();
    }

    function init() {
        const screen = document.querySelector("canvas.screen");
        display_text = new TextDisplay(rom_342_0265_a, screen);
        display_hires = new HiresDisplay(screen);

        io_mgr = new IOManager(mem, kbd, display_text, display_hires);

        document.addEventListener('keydown', kbd.key_down.bind(kbd));
        document.addEventListener('keyup', kbd.key_up.bind(kbd));

        run_stop_btn = document.getElementById("run_stop");
        run_stop_btn.addEventListener("click", run_toggle);
        document.getElementById("reset").addEventListener("click", reset);

        cycles = 0;
        cpu.register.pc = mem.read_word(0xfffc);

        const msg = 'press "run" below to start vm';
        for(let i=0; i<msg.length; i++) display_text.draw_text(mem, 0x042d+i, msg.charCodeAt(i)+0x80);
    }

    if(document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => { init(); });
    } else {
        init();
    }
  </script>
</body>
</html>
